{% set initial = initialScene|default({}) %}
{% set formMode = mode|default('create') %}
{% set isEdit = formMode == 'edit' %}
{% set transform = initial.transform|default({}) %}
{% set position = transform.position|default({}) %}
{% set rotation = transform.rotation|default({}) %}
{% set scale = transform.scale|default({}) %}

<div class="ar-section ar-section--wide"
     data-controller="mindar-create"
     data-mindar-create-scenes-endpoint-value="{{ path('api_ar_scene_create') }}"
     data-mindar-create-upload-endpoint-value="{{ path('api_upload_mind') }}"
     data-mindar-create-cancel-url-value="{{ path('ar_gallery') }}"
     data-mindar-create-mode-value="{{ isEdit ? 'edit' : 'create' }}"
    {% if isEdit and initial.id is defined %}
        data-mindar-create-update-endpoint-value="{{ path('api_ar_scene_update', {id: initial.id}) }}"
    {% endif %}
    {% if initial is not empty %}
    data-mindar-create-initial-scene-value="{{ initial|json_encode|e('html_attr') }}"
    {% endif %}>
    <h1 class="ar-section__title">{{ isEdit ? 'Modifier la sc√®ne RA' : 'Cr√©ateur de sc√®ne RA (MindAR)' }}</h1>

    <form id="form-create" class="ar-form" data-mindar-create-target="form">
        <div class="form-group">
            <label for="title">Titre de la sc√®ne</label>
            <input type="text"
                   id="title"
                   name="title"
                   data-mindar-create-target="title"
                   placeholder="Ma sc√®ne RA"
                   value="{{ initial.title|default('') }}">
        </div>

        <!-- S√©lecteur de pack -->
        <div class="form-group">
            <label for="pack">Pack d'images cibles</label>
            <p class="ar-form__hint ar-form__hint--small">Choisissez le pack contenant les images de suivi MindAR.</p>

            <select id="pack"
                    name="pack"
                    class="form-control ar-form__select"
                    data-mindar-create-target="pack"
                    data-action="change->mindar-create#packChanged">

                {% if packs|length > 0 %}
                    <option value="" {% if not isEdit %}selected{% endif %} disabled>Choisissez un pack MindAR‚Ä¶</option>
                    {% for pack in packs %}
                        <option value="{{ pack.mindPath }}"
                                data-packname="{{ pack.name }}"
                            {% if pack.jsonPath is defined and pack.jsonPath %}
                                data-json="{{ pack.jsonPath }}"
                            {% endif %}
                            {% if pack.thumbnail is defined and pack.thumbnail %}
                                data-thumbnail="{{ pack.thumbnail }}"
                            {% endif %}
                            {% if pack.targetImages is defined and pack.targetImages %}
                                data-targets='{{ pack.targetImages|json_encode|e('html_attr') }}'
                            {% endif %}
                            {% if pack.models is defined and pack.models %}
                                data-models='{{ pack.models|json_encode|e('html_attr') }}'
                            {% endif %}
                            {% set items = pack.metadata.items ?? [] %}
                            {% if items is not empty %}
                            data-items='{{ items|json_encode|e('html_attr') }}'
                            {% endif %}
                            {% set selectedMindPath = initial.mindTargetPath|default(null) %}
                            {% if selectedMindPath and pack.mindPath == selectedMindPath %}selected{% endif %}>
                            {{ pack.name }}
                        </option>
                    {% endfor %}
                {% else %}
                    <option value="" selected disabled>Aucun pack disponible </option>
                {% endif %}
                {% if isEdit and initial.mindTargetPath is defined and initial.mindTargetPath %}
                    {% set hasExistingPath = false %}
                    {% for pack in packs %}
                        {% if pack.mindPath == initial.mindTargetPath %}
                            {% set hasExistingPath = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not hasExistingPath %}
                        <option value="{{ initial.mindTargetPath }}" data-packname="Pack existant" selected>Pack existant</option>
                    {% endif %}
                {% endif %}
            </select>

            <div id="pack-preview"
                 class="pack-preview-wrapper ar-form__preview"
                 data-mindar-create-target="packPreview">
                <p class="ar-form__hint">S√©lectionnez un motif pour afficher un aper√ßu.</p>
            </div>
        </div>

        <div class="form-group">
            <label for="targetIndex">Motif de reconnaissance</label>
            <p class="ar-form__hint ar-form__hint--small">Cliquez sur l'une des images du pack pour d√©finir la cible MindAR utilis√©e pour l'ancrage 3D.</p>

            <div class="target-grid" data-mindar-create-target="thumbs">
                <p class="ar-form__placeholder">Aucun pack MindAR d√©tect√© pour le moment.</p>
            </div>
            <p class="ar-form__info" data-mindar-create-target="targetInfo">
                S√©lectionnez une image pour confirmer la d√©tection MindAR.
            </p>
            <input type="hidden" id="targetIndex" name="targetIndex" value="{{ initial.targetIndex|default('') }}" data-mindar-create-target="targetIndex">
        </div>

        {% set hasModels = models is defined and models|length > 0 %}

        <fieldset class="form-group">
            <legend class="ar-form__legend">
                Type de contenu
            </legend>
            <p class="ar-form__hint ar-form__hint--small">S√©lectionnez le type d'√©l√©ment virtuel √† afficher sur la cible.</p>
            <div class="ar-form__options" role="radiogroup">
                <label class="ar-form__option">
                    <input type="radio"
                           name="assetType"
                           value="model"
                           class="radio"
                           data-mindar-create-target="assetType"
                           data-action="mindar-create#assetTypeChanged"
                           {% if initial.contentType|default('model') == 'model' %}checked{% endif %}>
                    <span>Mod√®le 3D (.glb)</span>
                </label>
                <label class="ar-form__option">
                    <input type="radio"
                           name="assetType"
                           value="video"
                           class="radio"
                           data-mindar-create-target="assetType"
                           data-action="mindar-create#assetTypeChanged"
                           {% if initial.contentType|default('model') == 'video' %}checked{% endif %}>
                    <span>Vid√©o (mp4/webm)</span>
                </label>
                <label class="ar-form__option">
                    <input type="radio"
                           name="assetType"
                           value="image"
                           class="radio"
                           data-mindar-create-target="assetType"
                           data-action="mindar-create#assetTypeChanged"
                           {% if initial.contentType|default('model') == 'image' %}checked{% endif %}>
                    <span>Image 2D (png/jpg)</span>
                </label>
            </div>
        </fieldset>

        <input type="hidden" id="asset" name="asset" data-mindar-create-target="asset" value="{{ initial.assetUrl|default('') }}">

        <div class="form-group" data-mindar-create-target="modelSection">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="asset">
                Biblioth√®que de mod√®les 3D
            </label>
            <p class="ar-form__hint ar-form__hint--small">Choisissez l'animation 3D affich√©e lorsque l'image d√©clencheur est d√©tect√©e.</p>

            {% if hasModels %}
                <div class="model-grid" data-mindar-create-target="modelChoices">
                    {% for model in models %}
                        <button type="button"
                                class="model-card"
                                data-mindar-create-target="modelChoice"
                                data-action="mindar-create#selectModel"
                                data-model-path="{{ model.path }}"
                                data-model-name="{{ model.name }}"
                                data-model-description="{{ model.description|default('') }}"
                                data-model-emoji="{{ model.emoji|default('') }}"
                                data-model-type="{{ model.type|default('model') }}"
                                {% if loop.first %}data-model-default="1"{% endif %}>
                            <span class="model-card__icon" aria-hidden="true">{{ model.emoji|default('üßä') }}</span>
                            <span class="model-card__title">{{ model.name }}</span>
                            {% if model.description is defined and model.description %}
                                <span class="model-card__description">{{ model.description }}</span>
                            {% endif %}
                        </button>
                    {% endfor %}
                </div>
                <div class="model-info" data-mindar-create-target="modelInfo">
                    <p class="ar-form__hint ar-form__hint--small">S√©lectionnez un mod√®le pour afficher ses d√©tails.</p>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    Aucun mod√®le 3D n'est disponible pour le moment.
                </div>
            {% endif %}
        </div>

        <div class="form-group hidden" data-mindar-create-target="videoSection">
            <label for="videoUrl">
                URL de la vid√©o
            </label>
            <p class="ar-form__hint ar-form__hint--small">Fichier mp4/webm compatible streaming. Activez la lecture automatique en pr√©parant la vid√©o sans son ou en mode silencieux.</p>
            <input type="url"
                   id="videoUrl"
                   class="form-control"
                   placeholder="https://cdn.example.com/videos/ar.mp4"
                   data-mindar-create-target="videoInput"
                   data-action="input->mindar-create#updateAssetFromInput change->mindar-create#updateAssetFromInput"
                   value="{{ initial.contentType|default('model') == 'video' ? initial.assetUrl|default('') : '' }}">
        </div>

        <div class="form-group hidden" data-mindar-create-target="imageSection">
            <label for="imageUrl">
                URL de l'image
            </label>
            <p class="ar-form__hint ar-form__hint--small">PNG/JPG avec transparence optionnelle. L'image est affich√©e sur un plan 2D.</p>
            <input type="url"
                   id="imageUrl"
                   class="form-control"
                   placeholder="https://cdn.example.com/images/overlay.png"
                   data-mindar-create-target="imageInput"
                   data-action="input->mindar-create#updateAssetFromInput change->mindar-create#updateAssetFromInput"
                   value="{{ initial.contentType|default('model') == 'image' ? initial.assetUrl|default('') : '' }}">
        </div>

        <div class="form-group">
            <label for="sound">Ambiance sonore</label>
            <select id="sound" name="sound" class="form-control ar-form__select" data-mindar-create-target="sound">
                <option value="" {% if initial.soundUrl is not defined or not initial.soundUrl %}selected{% endif %}>Aucune</option>
                <option value="/build/audio/forest.mp3" {% if initial.soundUrl|default('') == '/build/audio/forest.mp3' %}selected{% endif %}>For√™t</option>
                <option value="/build/audio/water.mp3" {% if initial.soundUrl|default('') == '/build/audio/water.mp3' %}selected{% endif %}>Eau</option>
                {% if initial.soundUrl is defined and initial.soundUrl and initial.soundUrl not in ['/build/audio/forest.mp3', '/build/audio/water.mp3'] %}
                    <option value="{{ initial.soundUrl }}" selected>{{ initial.soundUrl }}</option>
                {% endif %}
            </select>
        </div>

        <fieldset class="form-group">
            <legend class="ar-form__legend">Placement de l'√©l√©ment</legend>
            <p class="ar-form__hint ar-form__hint--small">Utilisez les valeurs num√©riques pour positionner pr√©cis√©ment le contenu virtuel sur la cible MindAR.</p>
            <div class="placement-grid">
                <div>
                    <h3 class="placement-grid__title">Position</h3>
                    <div class="placement-grid__row">
                        <label for="positionX">X</label>
                        <input type="number" step="0.01" id="positionX" value="{{ position.x|default(0) }}" data-mindar-create-target="positionX" data-action="input->mindar-create#transformChanged">
                    </div>
                    <div class="placement-grid__row">
                        <label for="positionY">Y</label>
                        <input type="number" step="0.01" id="positionY" value="{{ position.y|default(0) }}" data-mindar-create-target="positionY" data-action="input->mindar-create#transformChanged">
                    </div>
                    <div class="placement-grid__row">
                        <label for="positionZ">Z</label>
                        <input type="number" step="0.01" id="positionZ" value="{{ position.z|default(0) }}" data-mindar-create-target="positionZ" data-action="input->mindar-create#transformChanged">
                    </div>
                </div>
                <div>
                    <h3 class="placement-grid__title">Rotation (¬∞)</h3>
                    <div class="placement-grid__row">
                        <label for="rotationX">X</label>
                        <input type="number" step="1" id="rotationX" value="{{ rotation.x|default(0) }}" data-mindar-create-target="rotationX" data-action="input->mindar-create#transformChanged">
                    </div>
                    <div class="placement-grid__row">
                        <label for="rotationY">Y</label>
                        <input type="number" step="1" id="rotationY" value="{{ rotation.y|default(0) }}" data-mindar-create-target="rotationY" data-action="input->mindar-create#transformChanged">
                    </div>
                    <div class="placement-grid__row">
                        <label for="rotationZ">Z</label>
                        <input type="number" step="1" id="rotationZ" value="{{ rotation.z|default(0) }}" data-mindar-create-target="rotationZ" data-action="input->mindar-create#transformChanged">
                    </div>
                </div>
                <div>
                    <h3 class="placement-grid__title">√âchelle</h3>
                    <div class="placement-grid__row">
                        <label for="scaleX">X</label>
                        <input type="number" step="0.01" id="scaleX" value="{{ scale.x|default(1) }}" data-mindar-create-target="scaleX" data-action="input->mindar-create#transformChanged">
                    </div>
                    <div class="placement-grid__row">
                        <label for="scaleY">Y</label>
                        <input type="number" step="0.01" id="scaleY" value="{{ scale.y|default(1) }}" data-mindar-create-target="scaleY" data-action="input->mindar-create#transformChanged">
                    </div>
                    <div class="placement-grid__row">
                        <label for="scaleZ">Z</label>
                        <input type="number" step="0.01" id="scaleZ" value="{{ scale.z|default(1) }}" data-mindar-create-target="scaleZ" data-action="input->mindar-create#transformChanged">
                    </div>
                </div>
            </div>
        </fieldset>

        <div class="form-group">
            <label for="mindfile">Fichier cible (.mind)</label>
            <input type="file" id="mindfile" accept=".mind" data-mindar-create-target="mindfile" />
        </div>

        <div class="form-group ar-form__actions">
            <div class="ar-form__actions-primary">
                <button type="button" class="btn" data-action="mindar-create#preview">Pr√©visualiser</button>
                <button type="button" class="btn btn-secondary" data-action="mindar-create#save">{{ isEdit ? 'Mettre √† jour la sc√®ne' : 'Enregistrer la sc√®ne' }}</button>
            </div>
            <div class="ar-form__actions-secondary">
                {% if not isEdit %}
                    <button type="button" class="btn btn-light" data-action="mindar-create#newScene">Nouvelle sc√®ne</button>
                {% endif %}
                <button type="button" class="btn btn-light" data-action="mindar-create#resetForm">R√©initialiser</button>
                <button type="button" class="btn btn-tertiary" data-action="mindar-create#cancel">Annuler</button>
            </div>
        </div>
        <div class="ar-form__status hidden" data-mindar-create-target="status" role="status" aria-live="polite"></div>
    </form>

    <div class="divider"></div>

    <div id="preview" class="preview" data-mindar-create-target="preview" aria-live="polite">
        <div class="preview-placeholder">
            <p><em>Utilisez le bouton de pr√©visualisation pour ajuster le placement sans lancer la d√©tection.</em></p>
        </div>
    </div>

    <div class="share-panel hidden" data-mindar-create-target="sharePanel">
        <h2 class="share-panel__title">Exp√©rience publi√©e</h2>
        <p class="ar-form__hint">Partagez ce lien ou le QR code pour lancer la sc√®ne RA sur mobile ou ordinateur.</p>
        <p class="ar-form__hint">
            <a href="#" class="link" data-mindar-create-target="shareLink" target="_blank" rel="noopener">Voir la page de partage</a>
            ¬∑
            <a href="#" class="link" data-mindar-create-target="experienceLink" target="_blank" rel="noopener">Ouvrir directement l'exp√©rience</a>
        </p>
        <div class="share-panel__qr" data-mindar-create-target="shareQr"></div>
    </div>
</div>
