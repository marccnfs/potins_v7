{% block body %}
<div class="_wb">
    <div class="container_bo_member">
        <div class="bo_content">
            {% set total = totalSteps|default(6) %}
            {% set progress = progressSteps|default([]) %}
            {% set done = progressCount|default(progress|length) %}
            {% set steps = {
                1: 'Cryptex num√©rique',
                2: 'QR code g√©olocalis√©',
                3: 'Puzzle num√©rique',
                4: 'Formulaire logique',
                5: 'Vid√©o interactive',
                6: 'Code HTML minimal'
            } %}

            {% set resume = resumeStep|default(progress ? (progress|last + 1 > total ? total : progress|last + 1) : 1) %}
            {% set pct = total > 0 ? (done / total * 100) | round(0, 'floor') : 0 %}

            <div class="play-layout">
                {# --- Colonne INFO --- #}
                <aside class="play-aside">
                    <div class="card">
                        <h3>üèÜ Meilleurs scores</h3>
                        <ol class="lb">
                            {% for row in topSessions %}
                                <li>
                                    <span class="nick">{{ row.participant.nickname ?? 'Joueur ' ~ row.participant.id }}</span>
                                    <span class="pts">{{ row.score }} pts</span>
                                    <span class="d">{{ (row.durationMs/1000)|round }} s</span>
                                </li>
                            {% else %}
                                <li class="muted">Aucun score pour l‚Äôinstant.</li>
                            {% endfor %}
                        </ol>
                    </div>
                    {% if active or attempts|length > 0 %}
                        <div class="card">
                            <h3>üìà Mes parties</h3>
                            <ul class="stats" style="list-style:none;margin:0;padding:0;display:grid;gap:.45rem;">
                                {% if active %}
                                    <li style="display:flex;justify-content:space-between;align-items:center;">
                                        <span>Partie en cours</span>
                                        <span class="badge badge-primary">√âtape {{ resume }}</span>
                                    </li>
                                {% endif %}
                                {% if best %}
                                    <li style="display:flex;justify-content:space-between;align-items:center;">
                                        <span>Meilleur score</span>
                                        <strong>{{ best.score }} pts</strong>
                                    </li>
                                {% endif %}
                                <li style="display:flex;justify-content:space-between;align-items:center;">
                                    <span>Parties jou√©es</span>
                                    <span>{{ attempts|length }}</span>
                                </li>
                            </ul>
                            <a class="btn btn-light" style="margin-top:.6rem;" href="{{ path('dashboard_my_sessions') }}">Voir toutes mes parties</a>
                        </div>
                    {% endif %}
                </aside>
                <div class="entry-layout">

                    {% set uni = eg.universe ?? {} %}
                    {% set illustrations = eg.illustrations ?? [] %}
                    {% set cover = illustrations|first %}


                    <header class="entry-hero" style="position:relative;overflow:hidden;border-radius:12px;">
                        <div class="hero-bg" style="position:absolute;inset:0;z-index:0;">
                            {% if cover %}
                                <img src="{{ vich_uploader_asset(cover, 'imageFile') }}" alt="" style="width:100%;height:100%;object-fit:cover;display:block;">
                            {% else %}
                                <div style="width:100%;height:100%;background:linear-gradient(135deg,#e5e7eb,#f3f4f6);"></div>
                            {% endif %}
                            <div style="position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.15) 60%,rgba(0,0,0,0) 100%);"></div>
                        </div>

                        <div class="hero-body" style="position:relative;z-index:1;color:#fff;padding:1.2rem 1.2rem 1rem;">
                            <h1 class="hero-title" style="margin:.2rem 0;font-size:clamp(1.6rem,3.2vw,2.2rem);">{{ eg.title }}</h1>
                            {% set subtitle = (uni.contexte ?? uni.goal ?? uni.objectif ?? '') %}
                            {% if subtitle %}
                                <p class="hero-sub" style="opacity:.9;margin:.2rem 0 .6rem 0;">{{ subtitle|striptags|length > 180 ? (subtitle|striptags|slice(0,180) ~ '‚Ä¶') : subtitle|raw }}</p>
                            {% else %}
                                <p class="hero-sub" style="opacity:.9;margin:.2rem 0 .6rem 0;">Pr√™t¬∑e pour l‚Äôaventure ? R√©sous {{ total }} √©preuves pour d√©voiler le secret‚Ä¶</p>
                            {% endif %}

                            <div class="hero-actions" style="display:flex;gap:.5rem;flex-wrap:wrap;">
                                {% if active %}
                                    <a class="btn btn-primary" href="{{ path('play_step', { slug: eg.shareSlug, step: resume }) }}">Reprendre √† l‚Äô√©tape {{ resume }}</a>
                                    <a class="btn btn-light" href="{{ path('play_step', { slug: eg.shareSlug, step: 1, restart: 1 }) }}">Nouvelle partie</a>
                                {% else %}
                                    <a class="btn btn-primary" href="{{ path('play_step', { slug: eg.shareSlug, step: 1, restart: 1 }) }}">üé¨ Commencer</a>
                                    {% if done > 0 and done < total %}
                                        <a class="btn btn-light" href="{{ path('play_step', { slug: eg.shareSlug, step: resume }) }}">Reprendre √† l‚Äô√©tape {{ resume }}</a>
                                    {% elseif done >= total %}
                                        <a class="btn btn-light" href="{{ path('play_the_end', { slug: eg.shareSlug }) }}">Voir le final</a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="hero-progress" style="position:relative;z-index:1;background:rgba(255,255,255,.8);backdrop-filter:blur(2px);padding:.6rem 1rem;border-top:1px solid #e5e7eb;">
                            <div class="bar" style="height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;">
                                <span class="fill" style="display:block;height:100%;width: {{ pct }}%;background:#2563eb;"></span>
                            </div>
                            <div class="bar-caption" style="font-size:.9rem;margin-top:.35rem;color:#111;">{{ done }}/{{ total }} √©preuves compl√©t√©es</div>
                        </div>
                    </header>
                    <section class="card preamble">
                        <h2>Pr√©ambule</h2>

                        <div class="grid2" style="display:grid;grid-template-columns:1.2fr .8fr;gap:1rem;">
                            <div>
                                <h3>Contexte</h3>
                                {% if uni.contexte %}
                                    <p>{{ uni.contexte|raw }}</p>
                                {% else %}
                                    <p class="muted">Le ma√Ætre du jeu n‚Äôa pas encore pr√©cis√© le contexte.</p>
                                {% endif %}
                            </div>
                            <div>
                                <h3>Objectif</h3>
                                {% set goal = uni.goal ?? uni.objectif %}
                                {% if goal %}
                                <p>{{ goal|raw }}</p>
                                {% else %}
                                    <p class="muted">R√©sous les {{ total }} √©preuves pour atteindre ton but.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grid2" style="display:grid;grid-template-columns:1.2fr .8fr;gap:1rem;margin-top:.6rem;">
                            <div>
                                <h3>Conseils</h3>
                                {% if uni.guide ?? uni.howto %}
                                    <p>{{ (uni.guide ?? uni.howto)|raw }}</p>
                                {% else %}
                                    <ul>
                                        <li>Observe les d√©tails (chiffres, lettres, couleurs‚Ä¶).</li>
                                        <li>Partage tes id√©es avec ton √©quipe.</li>
                                        <li>Utilise les indices si besoin (‚àí1 point par indice).</li>
                                    </ul>
                                {% endif %}
                            </div>
                            <div>
                                <h3>Infos pratiques</h3>
                                <ul>
                                    <li>‚è± Dur√©e indicative : {{ uni.duration|default('~45 min') }}</li>
                                    <li>üéØ Niveau : {{ uni.level|default('Ouvert √† tous') }}</li>
                                    <li>üë§ Cr√©√© par : {{ eg.owner ? (eg.owner.nickname ?? 'Anonyme') : '‚Äî' }}</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                <main class="entry-main">
                    <section class="card">
                        <h2>Les √©preuves</h2>
                        <ol class="steps-list">
                            {% for i in 1..total %}
                                {% set p = eg.getPuzzleByStep(i) %}
                                {% set ready = p and p.ready %}
                                {% set solved = i in progress %}
                                <li class="step-item {{ solved ? 'is-ready is-cleared' : (ready ? 'is-ready' : 'is-locked') }}">
                                    <div class="step-head">
                                        <div class="step-index">{{ i }}</div>
                                        <div class="step-title">{{ steps[i] ?? '√âpreuve ' ~ i }}</div>
                                        <div class="step-status">
                                            {% if solved %}
                                                <span class="badge badge-primary">Termin√©e</span>
                                            {% elseif ready %}
                                                <span class="badge badge-success">Pr√™te</span>
                                            {% else %}
                                                <span class="badge">Bient√¥t‚Ä¶</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="step-actions">
                                        {% if ready %}
                                            <a class="btn btn-light" href="{{ path('play_step', { slug: eg.shareSlug, step: i }) }}">{{ solved ? 'Rejouer' : 'Jouer' }} l‚Äô√©tape {{ i }}</a>
                                        {% else %}
                                            <button class="btn" disabled>Indisponible</button>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                        </ol>
                    </section>

                    <section class="card ambience">
                        <h2>Briefing</h2>
                        <p class="muted">Lis attentivement : chaque √©preuve te donnera un indice pour la suivante. Tu peux revenir √† cette page √† tout moment.</p>
                        <details class="tip">
                            <summary>Conseils pour r√©ussir</summary>
                            <ul>
                                <li>Observe tout : lettres, chiffres, couleurs, sons.</li>
                                <li>Parle avec ton √©quipe et partage vos id√©es.</li>
                                <li>Si tu bloques, fais une pause de 30 secondes, puis r√©essaie.</li>
                            </ul>
                        </details>
                    </section>
                </main>

            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% use "js/js_escape.html.twig" %}
{% block javascripts %}
    {{ parent() }}
{% endblock %}
