{# templates/escape/garden.html.twig #}
{% block body %}
    {% set cfg = puzzle.config is iterable ? puzzle.config : {} %}
    {% set target = cfg.target|default({}) %}

    <div class="_wb">
        <div class="container_bo_member">
            <div class="bo_content">
                <div class="step-layout">
                    <div class="step-sidebar">
                        {% include 'pwa/escape/wizard/_infos_step.html.twig' with { step: 2, eg: eg, puzzle: puzzle } %}
                    </div>

                    <div class="step-main">

                        <header style="display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin-bottom:.75rem">
                            <div>
                                <h1 style="margin:0">Étape 2 — QR code géolocalisé</h1>
                                {% if puzzle.prompt %}<p class="text-muted" style="margin:.25rem 0 0">{{ puzzle.prompt }}</p>{% endif %}
                            </div>
                            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                                {% if puzzle.ready %}
                                    <a class="btn btn-light" href="{{ path('wizard_preview_step', { id: eg.id, step: 2 }) }}" target="_blank" rel="noopener">Aperçu admin</a>
                                {% endif %}
                                {% if eg.published and eg.shareSlug %}
                                    <a class="btn btn-light" href="{{ path('play_step', { slug: eg.shareSlug, step: 2 }) }}" target="_blank" rel="noopener">Voir côté joueur</a>
                                {% endif %}
                            </div>
                        </header>

                        <section class="card" style="margin-bottom:1rem">
                            <h3 style="margin:0 0 .5rem">Aperçu</h3>
                            <section id="preview-qr"
                                     data-controller="qr-geo"
                                     data-qr-geo-lat-value="{{ target.lat|default(47.0) }}"
                                     data-qr-geo-lng-value="{{ target.lng|default(-1.0) }}"
                                     data-qr-geo-radius-value="{{ cfg.radiusMeters|default(150) }}"
                                     data-qr-geo-ok-message-value="{{ cfg.okMessage|default('Bravo !') }}"
                                     data-qr-geo-deny-message-value="{{ cfg.denyMessage|default('Hors zone…') }}"
                                     data-qr-geo-need-https-message-value="{{ cfg.needHttpsMessage|default('HTTPS requis') }}">
                                <button data-action="click->qr-geo#check">Vérifier ma position</button>
                                <div data-qr-geo-target="msg" class="mt-2"></div>
                            </section>
                        </section>

                        {{ form_start(form, { attr: { id: 'form-step2' } }) }}
                        <section class="card">
                            <div class="grid" style="grid-template-columns:minmax(260px,1fr) minmax(320px,1fr)">
                                <div>
                                    {{ form_row(form.title) }}
                                    {{ form_row(form.prompt) }}
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
                                        {{ form_row(form.lat) }}
                                        {{ form_row(form.lng) }}
                                    </div>
                                </div>
                                <div>
                                    {{ form_row(form.radiusMeters) }}
                                    {{ form_row(form.okMessage) }}
                                    {{ form_row(form.denyMessage) }}
                                    {{ form_row(form.needHttpsMessage) }}
                                </div>
                            </div>
                            {#
                            <div class="form-actions" style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.75rem">
                                <button class="btn btn-primary">Enregistrer</button>
                                {% if puzzle.id %}
                                    <a class="btn" href="{{ path('wizard_preview_step', { id: eg.id, step: 2 }) }}" target="_blank" rel="noopener">Aperçu admin</a>
                                {% endif %}
                            </div>
                            #}
                        </section>
                        {{ form_end(form) }}

                        <div class="sticky-save">
                            <div class="sticky-inner">
                                <span class="text-muted">Étape 2 — QR géoloc</span>
                                <div style="display:flex;gap:.5rem">
                                    <button form="form-step2" class="btn btn-primary">Enregistrer</button>
                                    {% if puzzle.ready %}<a class="btn btn-light" href="{{ path('wizard_preview_step', { id: eg.id, step: 2 }) }}" target="_blank">Aperçu</a>{% endif %}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const f = document.getElementById('form-step2'); if(!f) return;
            const ids={lat:'{{ form.lat.vars.id }}',lng:'{{ form.lng.vars.id }}',rad:'{{ form.radiusMeters.vars.id }}',ok:'{{ form.okMessage.vars.id }}',deny:'{{ form.denyMessage.vars.id }}',https:'{{ form.needHttpsMessage.vars.id }}'};
            let t;const deb=(fn)=>{clearTimeout(t);t=setTimeout(fn,180);};
            function refresh(){
                const root=document.getElementById('preview-qr'); if(!root)return;
                const c=root.cloneNode(false); c.id='preview-qr';
                const g=id=>document.getElementById(id);
                c.setAttribute('data-controller','qr-geo');
                c.setAttribute('data-qr-geo-lat-value', g(ids.lat).value || '47');
                c.setAttribute('data-qr-geo-lng-value', g(ids.lng).value || '-1');
                c.setAttribute('data-qr-geo-radius-value', g(ids.rad).value || '150');
                c.setAttribute('data-qr-geo-ok-message-value', g(ids.ok).value || 'Bravo !');
                c.setAttribute('data-qr-geo-deny-message-value', g(ids.deny).value || 'Hors zone…');
                c.setAttribute('data-qr-geo-need-https-message-value', g(ids.https).value || 'HTTPS requis');
                c.innerHTML = `<button data-action="click->qr-geo#check">Vérifier ma position</button><div data-qr-geo-target="msg" class="mt-2"></div>`;
                root.replaceWith(c);
            }
            f.addEventListener('input', ()=>deb(refresh));
        })();
    </script>
{% endblock %}
{% use "js/js_escape.html.twig" %}
{% block javascripts %}
    {{ parent() }}
{% endblock %}

