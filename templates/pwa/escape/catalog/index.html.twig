{% macro pageUrl(q, difficulty, duration, sort, page) -%}
    {{ path('catalog', { q:q, difficulty:difficulty, duration:duration, sort:sort, page:page }) }}
{%- endmacro %}
{% import _self as m %}

{% set cards = cards|default([]) %}
{% set difficultyLabels = difficultyLabels|default({
    'easy': 'Facile',
    'medium': 'Moyenne',
    'hard': 'Difficile'
}) %}
{% set durationLabels = durationLabels|default({
    'short': '≤ 15 min',
    'medium': '16–30 min',
    'long': '30+ min'
}) %}
{% set sortLabels = sortLabels|default({
    'new': 'Nouveaux',
    'popular': 'Populaires',
    'title': 'Titre A→Z'
}) %}
<div class="catalog">

        <header class="cat-hero">
            <h1>Catalogue</h1>
            <p class="muted">Explore les escapes publiés. Filtre par durée ou difficulté, ou cherche un thème précis.</p>
            <form class="filters" method="get" action="{{ path('catalog') }}">
                <input type="search" name="q" value="{{ q }}" placeholder="Rechercher (IA, Histoire, code...)">
                <select name="difficulty">
                    <option value="">Difficulté</option>
                    {% for key, label in difficultyLabels %}
                        <option value="{{ key }}" {{ difficulty==key?'selected' }}>{{ label }}</option>
                    {% endfor %}
                </select>
                <select name="duration">
                    <option value="">Durée</option>
                    {% for key, label in durationLabels %}
                        <option value="{{ key }}" {{ duration==key?'selected' }}>{{ label }}</option>
                    {% endfor %}
                </select>
                <select name="sort">
                    {% for key, label in sortLabels %}
                        <option value="{{ key }}" {{ sort==key?'selected' }}>{{ label }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" type="submit">Filtrer</button>
                {% if q or difficulty or duration or sort!='new' %}
                    <a class="btn btn-light" href="{{ path('catalog') }}">Réinitialiser</a>
                {% endif %}
            </form>
            <div class="count muted">{{ total }} résultat{{ total>1?'s':'' }}</div>
        </header>

    {% if cards|length %}
            <section class="cards">
                {% for card in cards %}
                    {% set eg = card.game %}
                    {% set cover = card.cover %}
                    <article class="card">
                        <a class="thumb" href="{{ path('play_entry', { slug: eg.shareSlug }) }}">
                            {% if cover %}
                                <img src="{{ vich_uploader_asset(cover, 'imageFile') }}" alt="{{ eg.title }}">
                            {% else %}
                                <div class="ph"></div>
                            {% endif %}
                        </a>
                        <div class="meta">
                            <h3 class="title">
                                <a href="{{ path('play_entry', { slug: eg.shareSlug }) }}">{{ eg.title }}</a>
                            </h3>
                            <p class="desc">
                                par <strong>{{ card.ownerName }}</strong>
                                {% if card.summary %}
                                    · {{ card.summary }}
                                {% endif %}
                            </p>

                        </div>
                        <div class="badges">
                            {% if card.difficultyLabel %}
                                <span class="badge">{{ card.difficultyLabel }}</span>
                            {% endif %}
                            {% if card.durationLabel %}
                                <span class="badge">{{ card.durationLabel }}</span>
                            {% endif %}
                            {% if card.playsCount %}
                                <span class="badge">▶ {{ card.playsCount }}</span>
                            {% endif %}
                        </div>
                        <div class="actions">
                            <a class="btn btn-primary" href="{{ path('play_entry', { slug: eg.shareSlug }) }}">Jouer</a>
                            <a class="btn btn-light" href="{{ path('play_step', { slug: eg.shareSlug, step: 1 }) }}">Commencer</a>
                        </div>
                    </article>
                {% endfor %}
            </section>

            {% if pages > 1 %}
                {% set prev = page > 1 ? page - 1 : 1 %}
                {% set next = page < pages ? page + 1 : pages %}

                {# fenêtre centrée autour de la page courante, bornée à [1 ; pages] #}
                {% set start = page - 2 %}
                {% if start < 1 %}{% set start = 1 %}{% endif %}
                {% set end = page + 2 %}
                {% if end > pages %}{% set end = pages %}{% endif %}

                <nav class="pagination">
                    <a class="page {{ page==1 ? 'is-disabled' : '' }}"
                       href="{{ path('catalog', { q:q, difficulty:difficulty, duration:duration, sort:sort, page: 1 }) }}">«</a>

                    <a class="page {{ page==1 ? 'is-disabled' : '' }}"
                       href="{{ path('catalog', { q:q, difficulty:difficulty, duration:duration, sort:sort, page: prev }) }}">‹</a>

                    {% for p in start..end %}
                        <a class="page {{ p==page ? 'is-current' : '' }}"
                           href="{{ path('catalog', { q:q, difficulty:difficulty, duration:duration, sort:sort, page: p }) }}">
                            {{ p }}
                        </a>
                    {% endfor %}

                    <a class="page {{ page==pages ? 'is-disabled' : '' }}"
                       href="{{ path('catalog', { q:q, difficulty:difficulty, duration:duration, sort:sort, page: next }) }}">›</a>

                    <a class="page {{ page==pages ? 'is-disabled' : '' }}"
                       href="{{ path('catalog', { q:q, difficulty:difficulty, duration:duration, sort:sort, page: pages }) }}">»</a>
                </nav>
            {% endif %}



        {% else %}
            <section class="empty">
                <p>Aucun résultat. Essaie d’autres mots-clés ou enlève des filtres.</p>
                <a class="btn" href="{{ path('catalog') }}">Tout afficher</a>
            </section>
        {% endif %}

    </div>


