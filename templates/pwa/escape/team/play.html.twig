{% extends 'pwa/escape/basepublic.html.twig' %}

{% block body %}
    {% set steps = scenario.steps|default({}) %}
    {% set stepStates = session ? session.stepStates : {} %}
    {% set hintsUsed = session ? session.hintsUsed : 0 %}

    <section class="escape-team play"
             data-controller="escape-team-play"
             data-escape-team-play-complete-url-value="{{ path('escape_team_step_complete', {slug: run.shareSlug, teamId: team.id, step: '__STEP__'}) }}"
             data-escape-team-play-hint-url-value="{{ path('escape_team_consume_hint', {slug: run.shareSlug, teamId: team.id}) }}"
             data-escape-team-play-current-step-value="{{ currentStep }}"
             data-escape-team-play-total-steps-value="{{ totalSteps }}"
             data-escape-team-play-step-states-value='{{ stepStates|default({})|json_encode(constant('JSON_FORCE_OBJECT'))|e('html_attr') }}'
             data-escape-team-play-progress-url-value="{{ progressUrl }}"
             data-escape-team-play-qr-validate-url-value="{{ path('escape_team_qr_validate', {slug: run.shareSlug}) }}"
             data-escape-team-play-waiting-url-value="{{ path('escape_team_waiting', {slug: run.shareSlug, teamId: team.id}) }}"
             data-escape-team-play-team-id-value="{{ team.id }}"
             data-escape-team-play-expected-parts-value="3"
             data-escape-team-play-winner-url-value="{{ path('escape_team_winner', {slug: run.shareSlug}) }}"
             data-escape-team-play-hints-used-value="{{ hintsUsed }}"
             data-escape-team-play-need-https-message-value="{{ (steps[4] is defined and steps[4].config is defined and steps[4].config.needHttpsMessage is defined) ? steps[4].config.needHttpsMessage : 'Activez HTTPS pour utiliser le scanner sécurisé.' }}">
        <header class="escape-team__hero">
            <p class="kicker">Parcours équipe</p>
            <h1>{{ team.name }} · {{ run.title }}</h1>
            <p class="muted">Suis les 5 étapes : deux mots clés, trois logiques, un QR et le cryptex final.</p>
            {% if session %}
                <p class="muted">Indices utilisés : <span data-escape-team-play-target="hintsCounter">{{ hintsUsed }}</span> · Étape actuelle : {{ session.currentStep ?? 1 }}</p>
            {% endif %}
            {% if run.status != 'running' %}
                <div class="alert alert-warning">Le jeu n'est pas encore lancé. Reste en attente du maître.</div>
            {% endif %}
        </header>

        <div class="alert alert-warning" data-escape-team-play-target="runAlert" hidden></div>

        <div class="escape-team__grid steps">
            {% for num, step in steps %}
            {% set state = stepStates[num] ?? {} %}
                {% set unlocked = (stepStates[num] ?? false) and (stepStates[num].completedAt is defined) or num <= currentStep %}
                <article class="escape-team__panel" data-escape-team-play-target="step" data-step="{{ num }}" {% if not unlocked %}hidden{% endif %}>
                <header class="escape-team__step-head">
                    <div>
                        <p class="kicker">Étape {{ num }}</p>
                        <h2>{{ step.title }}</h2>
                        <p class="muted">{{ step.prompt }}</p>
                    </div>
                    <div class="escape-team__status {{ state.completedAt is defined ? 'done' : '' }}">
                        {% if state.completedAt is defined %}
                            <span class="badge">Validée</span>
                            <small class="muted">{{ state.completedAt|date('H:i') }}</small>
                        {% else %}
                            <span class="badge badge-secondary">En cours</span>
                        {% endif %}
                    </div>
                </header>

                <div class="escape-team__content">
                    {% if step.type == 'text' %}
                    <form class="escape-team__form" data-action="submit->escape-team-play#submitTextStep" data-step="{{ num }}" data-solution="{{ step.solution|lower }}">
                        <label>Mot ou phrase attendu·e</label>
                        <input type="text" name="answer" placeholder="Tape la réponse trouvée" {% if state.completedAt is defined %}disabled{% endif %} required>
                        <p class="muted">Validation uniquement si le mot correspond exactement.</p>
                        <button class="btn btn-primary" type="submit" {% if state.completedAt is defined %}disabled{% endif %}>Valider l'étape</button>
                    </form>
                    {% elseif step.type == 'logic' %}
                        <div class="escape-team__logic" data-step="{{ num }}">
                            {% for part in step.questions|default([]) %}
                                <div class="escape-team__logic-part"
                                     data-step="{{ num }}"
                                     data-part-key="logic{{ loop.index }}"
                                     data-action="logic-form:solved->escape-team-play#recordLogicPart">
                                    {% include 'pwa/escape/puzzles/_logic_form.html.twig' with { cfg: { questions: [part], okMessage: step.okMessage|default('Bravo !'), failMessage: step.failMessage|default('Réessaie.') } } %}
                                </div>
                            {% endfor %}
                            <p class="muted">Les trois mini-tests doivent être validés pour clôturer l'étape.</p>
                            </div>
                    {% elseif step.type == 'qr_print' %}
                        <div class="escape-team__qr" data-step="{{ num }}">
                            <p class="muted">Le maître du jeu a caché un QR code dans la zone de jeu. Scannez-le avec votre appareil ou un autre téléphone : vous obtiendrez un mot secret à renseigner ci-dessous pour valider l’étape.</p>
                            <div class="qr-actions">
                                <button class="btn btn-primary" type="button" data-action="click->escape-team-play#startQrScan" data-step="{{ num }}">Scanner le QR caché</button>
                                <button class="btn btn-light" type="button" data-action="click->escape-team-play#stopQrScan" data-step="{{ num }}" data-escape-team-play-target="qrStop" hidden>Arrêter le scan</button>
                            </div>
                            <div class="qr-scan" data-escape-team-play-target="qrWrapper" hidden>
                                <video data-escape-team-play-target="qrVideo" playsinline muted hidden></video>
                            </div>
                            <div class="muted" data-escape-team-play-target="qrStatus"></div>
                            <hr>
                            <form class="escape-team__form" data-action="submit->escape-team-play#submitTextStep" data-step="{{ num }}" data-solution="{{ step.secretWord|default('')|lower }}">
                                <label>Mot secret révélé par le scan</label>
                                <input type="text" name="answer" placeholder="Saisis le mot affiché sur l’autre appareil" {% if state.completedAt is defined %}disabled{% endif %} required>
                                <p class="muted">Si la caméra n’est pas disponible, scanne le QR caché avec un autre appareil : le mot affiché doit être recopié ici pour valider l’étape.</p>
                                <button class="btn btn-primary" type="submit" {% if state.completedAt is defined %}disabled{% endif %}>Valider l'étape avec le mot secret</button>
                            </form>
                        </div>
                    {% elseif step.type == 'cryptex' %}
                        <div class="escape-team__cryptex" data-step="{{ num }}">
                            <div data-controller="cryptex"
                                 data-cryptex-solution-value="{{ step.solution|upper }}"
                                 data-cryptex-alphabet-value="{{ step.alphabet|default('ABCDEFGHIJKLMNOPQRSTUVWXYZ') }}"
                                 data-cryptex-scramble-value="true"
                                 data-cryptex-autocheck-value="true"
                                 data-cryptex-success-message-value="{{ step.successMessage|default('Cryptex ouvert !') }}">
                                <div data-cryptex-target="status" class="muted"></div>
                                <div class="cryptex-rings" data-cryptex-target="rings"></div>
                                <button class="btn btn-primary" type="button" data-cryptex-target="reveal" data-action="cryptex#reveal">Déverrouiller</button>
                                <div data-cryptex-target="secret" class="muted" hidden>Bravo ! Note le mot final pour le maître du jeu.</div>
                            </div>
                        </div>
                    {% endif %}

                    {% if step.hints is defined and step.hints|length %}
                        <div class="escape-team__hints"
                             data-controller="hints"
                             data-hints-slug-value="{{ run.shareSlug }}"
                             data-hints-step-value="{{ num }}"
                             data-hints-total-value="{{ step.hints|length }}">
                            <h3>Indices</h3>
                            <ol class="hints">
                                {% for hint in step.hints %}
                                    <li class="hint-item" data-hints-target="hint" hidden>{{ hint }}</li>
                                {% endfor %}
                            </ol>
                            <div class="hints-actions">
                                <button class="btn btn-light" data-action="click->hints#revealNext click->escape-team-play#consumeHint" data-step="{{ num }}">Afficher un indice</button>
                                <span class="muted" data-hints-target="counter"></span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="feedback" data-escape-team-play-target="feedback" data-step="{{ num }}"></div>
            </article>
            {% endfor %}
        </div>
    </section>
{% endblock %}


