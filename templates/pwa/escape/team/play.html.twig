{% extends 'pwa/escape/basepublic.html.twig' %}

{% block body %}
    {% set steps = scenario.steps|default({}) %}
    {% set stepStates = session ? session.stepStates : {} %}

    <section class="escape-team play"
             data-controller="escape-team-play"
             data-escape-team-play-complete-url-value="{{ path('escape_team_step_complete', {slug: run.shareSlug, teamId: team.id, step: '__STEP__'}) }}"
             data-escape-team-play-hint-url-value="{{ path('escape_team_consume_hint', {slug: run.shareSlug, teamId: team.id}) }}"
             data-escape-team-play-step-states-value='{{ stepStates|json_encode|e('html_attr') }}'
             data-escape-team-play-expected-parts-value="3">
        <header class="escape-team__hero">
            <p class="kicker">Parcours équipe</p>
            <h1>{{ team.name }} · {{ run.title }}</h1>
            <p class="muted">Suis les 5 étapes : deux mots clés, trois logiques, un QR et le cryptex final.</p>
            {% if session %}
                <p class="muted">Indices utilisés : {{ session.hintsUsed }} · Étape actuelle : {{ session.currentStep ?? 1 }}</p>
            {% endif %}
            {% if run.status != 'running' %}
                <div class="alert alert-warning">Le jeu n'est pas encore lancé. Reste en attente du maître.</div>
            {% endif %}
        </header>

        <div class="escape-team__grid steps">
            {% for num, step in steps %}
            {% set state = stepStates[num] ?? {} %}
            <article class="escape-team__panel" data-escape-team-play-target="step" data-step="{{ num }}">
                <header class="escape-team__step-head">
                    <div>
                        <p class="kicker">Étape {{ num }}</p>
                        <h2>{{ step.title }}</h2>
                        <p class="muted">{{ step.prompt }}</p>
                    </div>
                    <div class="escape-team__status {{ state.completedAt is defined ? 'done' : '' }}">
                        {% if state.completedAt is defined %}
                            <span class="badge">Validée</span>
                            <small class="muted">{{ state.completedAt|date('H:i') }}</small>
                        {% else %}
                            <span class="badge badge-secondary">En cours</span>
                        {% endif %}
                    </div>
                </header>

                <div class="escape-team__content">
                    {% if step.type == 'text' %}
                    <form class="escape-team__form" data-action="submit->escape-team-play#submitTextStep" data-step="{{ num }}" data-solution="{{ step.solution|lower }}">
                        <label>Mot ou phrase attendu·e</label>
                        <input type="text" name="answer" placeholder="Tape la réponse trouvée" {% if state.completedAt is defined %}disabled{% endif %} required>
                        <p class="muted">Validation uniquement si le mot correspond exactement.</p>
                        <button class="btn btn-primary" type="submit" {% if state.completedAt is defined %}disabled{% endif %}>Valider l'étape</button>
                    </form>
                    {% elseif step.type == 'logic' %}
                        <div class="escape-team__logic" data-step="{{ num }}">
                            {% for part in step.questions|default([]) %}
                                <div class="escape-team__logic-part"
                                     data-step="{{ num }}"
                                     data-part-key="logic{{ loop.index }}"
                                     data-action="logic-form:solved->escape-team-play#recordLogicPart">
                                    {% include 'pwa/escape/puzzles/_logic_form.html.twig' with { cfg: { questions: [part], okMessage: step.okMessage|default('Bravo !'), failMessage: step.failMessage|default('Réessaie.') } } %}
                                </div>
                            {% endfor %}
                            <p class="muted">Les trois mini-tests doivent être validés pour clôturer l'étape.</p>
                            </div>
                    {% elseif step.type == 'qr_print' %}
                        <div class="escape-team__qr"
                             data-step="{{ num }}"
                             data-action="qr-print:generated->escape-team-play#onQrGenerated">
                            <div data-controller="qr-print"
                                 data-qr-print-fetch-url-value="{{ path('escape_team_qr_token', {slug: run.shareSlug, teamId: team.id}) }}"
                                 data-qr-print-ready-message-value="Génère le QR puis scanne-le avec un smartphone"
                                 data-qr-print-generated-message-value="QR prêt, scannez-le pour continuer"
                                 data-qr-print-generating-message-value="Génération en cours..."
                                 data-qr-print-error-message-value="Impossible de générer le QR"
                                 data-qr-print-no-expiry-message-value="Pas d'expiration">
                                <p class="muted" data-qr-print-target="placeholder">Clique sur « Générer » pour créer le QR d'équipe.</p>
                                <div class="qr-print" data-qr-print-target="details" hidden>
                                    <figure class="qr-print__figure">
                                        <img data-qr-print-target="qrImage" alt="QR de validation" />
                                        <figcaption class="muted" data-qr-print-target="expires" hidden></figcaption>
                                    </figure>
                                    <div class="qr-print__actions">
                                        <button class="btn" data-qr-print-target="generateButton" data-action="qr-print#generate">Générer</button>
                                        <button class="btn btn-light" data-qr-print-target="printButton" data-action="qr-print#print" disabled>Imprimer</button>
                                    </div>
                                    <p class="muted" data-qr-print-target="directWrapper" hidden>
                                        <a data-qr-print-target="directLink" href="#" target="_blank" rel="noopener"></a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% elseif step.type == 'cryptex' %}
                        <div class="escape-team__cryptex" data-step="{{ num }}">
                            <div data-controller="cryptex"
                                 data-cryptex-solution-value="{{ step.solution|upper }}"
                                 data-cryptex-alphabet-value="{{ step.alphabet|default('ABCDEFGHIJKLMNOPQRSTUVWXYZ') }}"
                                 data-cryptex-scramble-value="false"
                                 data-cryptex-autocheck-value="true"
                                 data-cryptex-success-message-value="{{ step.successMessage|default('Cryptex ouvert !') }}">
                                <div data-cryptex-target="status" class="muted"></div>
                                <div class="cryptex-rings" data-cryptex-target="rings"></div>
                                <button class="btn btn-primary" type="button" data-cryptex-target="reveal" data-action="cryptex#reveal">Déverrouiller</button>
                                <div data-cryptex-target="secret" class="muted" hidden>Bravo ! Note le mot final pour le maître du jeu.</div>
                            </div>
                        </div>
                    {% endif %}

                    {% if step.hints is defined and step.hints|length %}
                        <div class="escape-team__hints"
                             data-controller="hints"
                             data-hints-slug-value="{{ run.shareSlug }}"
                             data-hints-step-value="{{ num }}"
                             data-hints-total-value="{{ step.hints|length }}">
                            <h3>Indices</h3>
                            <ol class="hints">
                                {% for hint in step.hints %}
                                    <li class="hint-item" data-hints-target="hint" hidden>{{ hint }}</li>
                                {% endfor %}
                            </ol>
                            <div class="hints-actions">
                                <button class="btn btn-light" data-action="click->hints#revealNext click->escape-team-play#consumeHint" data-step="{{ num }}">Afficher un indice</button>
                                <span class="muted" data-hints-target="counter"></span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="feedback" data-escape-team-play-target="feedback" data-step="{{ num }}"></div>
            </article>
            {% endfor %}
        </div>
    </section>
{% endblock %}


