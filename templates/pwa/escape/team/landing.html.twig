{% extends 'pwa/escape/basepublic.html.twig' %}

{% set statusLabels = {
    'draft': 'Préparation',
    'registration': 'Inscriptions ouvertes',
    'locked': 'Inscriptions closes',
    'running': 'Jeu en cours',
    'ended': 'Partie terminée'
} %}

{% set avatarImageUrls = {} %}
{% for key, path in avatarImages|default({}) %}
    {% set avatarImageUrls = avatarImageUrls|merge({ (key): asset(path) }) %}
{% endfor %}

{% block body %}
    <section class="escape-team landing" data-progress-endpoint="{{ path('escape_team_progress', {slug: run.shareSlug}) }}" data-run-url="{{ path('escape_team_live', {slug: run.shareSlug}) }}" data-winner-url="{{ path('escape_team_winner', {slug: run.shareSlug}) }}" data-avatar-images='{{ avatarImageUrls|json_encode|e('html_attr') }}'>
        <header class="escape-team__hero">
            <p class="kicker">Escape game par équipes</p>
            <h1>{{ run.title }}</h1>
           {#  <p class="muted">Projette cette page : le lien et le QR code permettent aux équipes de s'inscrire en direct.</p> #}
            {% if run.heroImageUrl %}
                <img class="escape-team__hero-img" src="{{ run.heroImageUrl }}" alt="Visuel de l'univers">
            {% endif %}

            <div class="escape-team__share">
                <div class="escape-team__share-link">
                    <p class="muted">Code d'accès</p>
                    <code class="escape-team__slug">{{ run.registrationCode ?? '—' }}</code>
                    <p class="muted">Partage ce code pour une saisie rapide depuis nomdedomaine/escape-team.</p>
                </div>
                <div class="escape-team__share-link">
                    <p class="muted">Lien d'inscription</p>
                    <code class="escape-team__slug" id="escape-team-link">{{ registrationUrl }}</code>
                   {#  <a class="btn" href="{{ registrationUrl }}" target="_blank">Ouvrir la page d'inscription</a> #}
                </div>
                <div class="escape-team__share-qr">
                    <img src="{{ registrationQr }}" alt="QR code d'inscription" />
                    <small>Scannez pour rejoindre</small>
                </div>
            </div>
        </header>

        <div class="escape-team__grid escape-team__grid--landing">
            <div class="escape-team__panel">
                <div class="escape-team__metrics">
                    <div class="escape-team__metric">
                        <span class="escape-team__metric-label">Équipes</span>
                        <strong><span id="landing-counter">{{ teams|length }}</span> / {{ run.maxTeams }}</strong>
                    </div>
                    <div class="escape-team__metric">
                        <span class="escape-team__metric-label">Statut</span>
                        <span class="badge">{{ statusLabels[run.status]|default(run.status) }}</span>
                    </div>
                    <div class="escape-team__metric">
                        <span class="escape-team__metric-label">Limite</span>
                        <strong>{{ run.timeLimitSeconds ? (run.timeLimitSeconds/60)|round(0, 'ceil') ~ ' min' : 'Aucune' }}</strong>
                    </div>
                </div>
                <p class="muted">La liste des équipes se met à jour automatiquement. Au lancement, la projection bascule vers le déroulement.</p>
            </div>

            <div class="escape-team__panel">
                <div class="escape-team__panel-head">
                    <h2>Équipes inscrites</h2>
                    <span class="badge badge--ghost">{{ statusLabels[run.status]|default(run.status) }}</span>
                </div>
                <div id="landing-teams" class="escape-team__cards">
                    {% if teams is empty %}
                        <p class="muted" data-empty>En attente des premières équipes…</p>
                    {% else %}

                        {% for team in teams %}
                    <div class="escape-team__card" style="--team-color: {{ team.color ?? '#4ecdc4' }}">
                        <div class="escape-team__card-head">
                            {{ include('pwa/escape/team/_avatar.html.twig', { avatarKey: team.avatarKey, avatarImages: avatarImages|default({}) }) }}
                            <div>
                                <strong>{{ team.name }}</strong>
                                <p class="muted">{{ team.members|length }} joueur(s)</p>
                            </div>
                                </div>
                    </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const section = document.querySelector('.escape-team.landing');
            if (!section) return;
            const endpoint = section.dataset.progressEndpoint;
            const runUrl = section.dataset.runUrl;
            const winnerUrl = section.dataset.winnerUrl;
            const cards = document.getElementById('landing-teams');
            const counter = document.getElementById('landing-counter');
            const palette = ['#ff6b6b','#4ecdc4','#ffd166','#cdb4db','#6c5ce7','#00a8e8','#f4a261','#2ec4b6','#e76f51','#ff8fa3'];
            const avatarImages = JSON.parse(section.dataset.avatarImages || '{}');
            let redirecting = false;

            const renderAvatar = (key) => {
                const url = avatarImages[key];
                if (!url) {
                    return `<span class="escape-team__avatar">${key}</span>`;
                }

                return `
                    <span class="escape-team__avatar escape-team__avatar--image">
                        <img src="${url}" alt="Avatar ${key}" loading="lazy" />
                    </span>`;
            };

            const renderTeams = (data) => {
                if (!cards || !data) return;
                const teams = data.teams || [];
                if (counter) {
                    counter.textContent = teams.length;
                }
                if (teams.length === 0) {
                    cards.innerHTML = '<p class="muted" data-empty>En attente des premières équipes…</p>';
                    return;
                }

                cards.innerHTML = teams.map((team, index) => {
                    const color = team.color || palette[index % palette.length];
                    const sizeLabel = team.memberCount ? `${team.memberCount} joueur(s)` : 'Équipe prête';
                    return `
                        <div class="escape-team__card" style="--team-color:${color}">
                            <div class="escape-team__card-head">
                                 ${renderAvatar(team.avatarKey)}
                                <div>
                                    <strong>${team.teamName}</strong>
                                    <p class="muted">${sizeLabel}</p>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            };

            const poll = () => {
                fetch(endpoint)
                    .then((r) => r.json())
                    .then((data) => {
                        renderTeams(data);
                        if (redirecting) return;
                        if (data.winner) {
                            redirecting = true;
                            window.location.href = winnerUrl;
                            return;
                        }
                        if (data.status === 'running') {
                            redirecting = true;
                            window.location.href = runUrl;
                        }
                    })
                    .catch(() => {});
            };

            poll();
            setInterval(poll, 4000);
        })();
    </script>
{% endblock %}
