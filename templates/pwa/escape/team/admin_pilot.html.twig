{% extends 'pwa/escape/basepublic.html.twig' %}

{% set avatarImageUrls = {} %}
{% for key, path in avatarImages|default({}) %}
    {% set avatarImageUrls = avatarImageUrls|merge({ (key): asset(path) }) %}
{% endfor %}

{% block body %}
    <section class="escape-team pilot">
        <header class="escape-team__hero">
            <p class="kicker">Pilotage maître de jeu</p>
            <h1>{{ run.title }}</h1>
            <p class="muted">Lance la session et suis la progression en direct. Les inscriptions sont verrouillées au départ.</p>
        </header>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}">{{ message }}</div>
            {% endfor %}
        {% endfor %}

        <div class="escape-team__grid">
            <div class="escape-team__panel">
                <h2>Réglages</h2>
                <p>Statut actuel : <strong>{{ run.status }}</strong></p>
                <p>Inscriptions : {{ run.isRegistrationOpen ? 'ouvertes' : 'fermées' }}</p>
                <form method="post" class="escape-team__pilot-form">
                    <label>Temps limite commun (minutes)</label>
                    <input type="number" name="timeLimitMinutes" min="0" value="{{ run.timeLimitSeconds ? (run.timeLimitSeconds/60)|round(0, 'ceil') : '' }}" />
                    <div class="escape-team__pilot-actions">
                        <button class="btn" type="submit" name="action_open" {% if run.status == 'running' %}disabled{% endif %}>Ouvrir inscriptions</button>
                        <button class="btn" type="submit" name="action_close" {% if run.status == 'running' %}disabled{% endif %}>Clôturer inscriptions</button>
                        <button class="btn btn-primary" type="submit" name="action_launch" {% if run.status == 'running' %}disabled{% endif %}>Lancer le jeu</button>
                        <button class="btn btn-danger" type="submit" name="action_stop" onclick="return confirm('Arrêter le jeu en cours ? Les équipes seront renvoyées en attente.');" {% if run.status != 'running' %}disabled{% endif %}>Arrêter le jeu</button>
                        {% if run.status == 'stopped' %}
                            <button class="btn btn-warning" type="submit" name="action_reset" onclick="return confirm('Réinitialiser le jeu ? Les équipes seront supprimées et la session reviendra à l\'état initial.');">
                                Réinitialiser le jeu
                            </button>
                        {% endif %}
                    </div>
                </form>
                <p class="muted">Un lancement initialise les chronos d'équipe, ferme les inscriptions et redirige la projection vers le déroulement.</p>
                <div class="escape-team__actions">
                    <a class="btn" href="{{ path('escape_team_landing', {slug: run.shareSlug}) }}" target="_blank">Projeter les inscriptions</a>
                    <a class="btn" href="{{ path('escape_team_live', {slug: run.shareSlug}) }}" target="_blank">Projeter le déroulement</a>
                    <a class="btn" href="#qr-groups">Afficher les groupes QR</a>
                    <a class="btn btn-light" href="{{ path('escape_team_qr_group_new', {slug: run.shareSlug}) }}">Créer un groupe QR</a>
                </div>
            </div>

            <div class="escape-team__panel">
                <h2>Équipes inscrites</h2>
                {% if teams is empty %}
                    <p class="muted">Aucune équipe inscrite pour le moment.</p>
                {% else %}
                    <ul class="escape-team__list">
                        {% for team in teams %}
                            <li class="escape-team__card">
                                {{ include('pwa/escape/team/_avatar.html.twig', { avatarKey: team.avatarKey, avatarImages: avatarImages|default({}) }) }}
                                <div>
                                    <strong>{{ team.name }}</strong>
                                    <p class="muted">{{ team.members|length }} joueur(s)</p>
                                    {% if team.session %}
                                        <small>Étape en cours : {{ team.session.currentStep ?? 'terminé' }}</small>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <div class="escape-team__panel">
            <h2>QR caché · étape 4</h2>
            <p class="muted">Génère et imprime le QR code à cacher dans l’espace de jeu. Son scan valide automatiquement l’étape 4 pour l’équipe.</p>
            <div data-controller="qr-print"
                 data-qr-print-fetch-url-value="{{ path('escape_team_hidden_qr_token', {slug: run.shareSlug}) }}"
                 data-qr-print-print-url-value="{{ path('escape_team_hidden_qr_print', {slug: run.shareSlug, token: '__TOKEN__'}) }}"
                 data-qr-print-ready-message-value="Clique sur générer pour créer le QR caché"
                 data-qr-print-generated-message-value="QR prêt : imprime-le et cache-le"
                 data-qr-print-generating-message-value="Génération en cours..."
                 data-qr-print-error-message-value="Impossible de générer le QR"
                 data-qr-print-no-expiry-message-value="Permanent">
                <p class="muted" data-qr-print-target="placeholder">Le QR caché sera unique pour « {{ run.title }} ».</p>
                <div class="qr-print" data-qr-print-target="details" hidden>
                    <figure class="qr-print__figure">
                        <img data-qr-print-target="qrImage" alt="QR caché" />
                        <figcaption class="muted" data-qr-print-target="expires" hidden></figcaption>
                    </figure>
                    <div class="qr-print__actions">
                        <button class="btn" data-qr-print-target="generateButton" data-action="qr-print#generate">Générer</button>
                        <button class="btn btn-light" data-qr-print-target="printButton" data-action="qr-print#print" disabled>Imprimer</button>
                    </div>
                    <p class="muted" data-qr-print-target="directWrapper" hidden>
                        <a data-qr-print-target="directLink" href="#" target="_blank" rel="noopener"></a>
                    </p>
                </div>
            </div>
        </div>

        <div id="qr-groups" class="escape-team__panel">
            <h2>Groupes QR</h2>
            <p class="muted">Organise les pages QR des équipes pour cette session.</p>
            {% if qrGroups is empty %}
                <p class="muted">Aucun groupe QR créé pour le moment.</p>
                <a class="btn btn-light" href="{{ path('escape_team_qr_group_new', {slug: run.shareSlug}) }}">Créer un premier groupe QR</a>
            {% else %}
                <ul class="escape-team__list">
                    {% for group in qrGroups %}
                        <li class="escape-team__card">
                            <div>
                                <strong>{{ group.name }}</strong>
                                <p class="muted">Créé le {{ group.createdAt|date('d/m/Y') }} · {{ group.pages|length }} page(s) QR</p>
                            </div>
                            <a class="btn" href="{{ path('escape_team_qr_group_show', {slug: run.shareSlug, id: group.id}) }}">Voir le groupe</a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <div class="escape-team__panel">
            <h2>Live</h2>
            <div id="pilot-live" data-endpoint="{{ path('escape_team_progress', {slug: run.shareSlug}) }}" data-avatar-images='{{ avatarImageUrls|json_encode|e('html_attr') }}'></div>
        </div>
    </section>
{% endblock %}

{% use "js/js_escape.html.twig" %}
{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const target = document.getElementById('pilot-live');
            if (!target) return;
            const endpoint = target.dataset.endpoint;
            const avatarImages = JSON.parse(target.dataset.avatarImages || '{}');

            const renderAvatar = (key) => {
                const url = avatarImages[key];
                if (!url) {
                    return `<span class="escape-team__avatar">${key}</span>`;
                }

                return `
                    <span class="escape-team__avatar escape-team__avatar--image">
                        <img src="${url}" alt="Avatar ${key}" loading="lazy" />
                    </span>`;
            };
            const render = (data) => {
                if (!data) return;
                let html = '<ul class="escape-team__list">';
                data.teams.forEach((team) => {
                    html += `
                        <li class="escape-team__card">
                             ${renderAvatar(team.avatarKey)}
                            <div>
                                <strong>${team.teamName}</strong>
                                <p class="muted">Progression : ${team.completedSteps}/${data.stepCount} · indices ${team.hintsUsed}</p>
                                <small>${team.isCompleted ? 'Terminé' : 'Étape ' + (team.currentStep || 1)}</small>
                            </div>
                        </li>`;
                });
                html += '</ul>';
                target.innerHTML = html;
            };

            const poll = () => {
                fetch(endpoint)
                    .then((r) => r.json())
                    .then(render)
                    .catch(() => {});
            };

            poll();
            setInterval(poll, 5000);
        })();
    </script>
{% endblock %}
